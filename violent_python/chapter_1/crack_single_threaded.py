#!/usr/bin/env python3

# This version is improved from the book's.
# It can be fed an /etc/shadow file from a
# modern Linux distro. It's also multithreaded.

import itertools
from concurrent.futures import ThreadPoolExecutor
import crypt
import argparse
from datetime import datetime
from helper_functions import lazy_load



def test_pass(word: str, user: dict) -> None:
        created_hash = crypt.crypt(word, user["salt"])
        if created_hash == user["hash"]:
            print(f"\n[+] Found user:pass -- {user['name']}:{word}")
            return True
        return False

def main():
    parser = argparse.ArgumentParser()
    optional = parser._action_groups.pop()
    required = parser.add_argument_group("required arguments")
    optional = parser.add_argument_group("optional arguments")
    required.add_argument("-f", "--file", type=str, help="shadow-like file to crack", required=True)
    required.add_argument("-d", "--dictionary", type=str, help="dictionary file to use", required=True)
    args = parser.parse_args()

    start_time = datetime.now()

    # parse shadow file and add the users to the list uncracked_users
    uncracked_users = []
    with open(args.file, "r") as shadow_file:
        for line in shadow_file:
            if ":" in line:
                username = line.split(":")[0]
                hash_ = line.split(":")[1].strip(" ")
                split_hash = hash_.split("$")
                if len(split_hash) == 4:
                    print(f"[*] {username}:{hash_}")
                    user_dict = {"name": username, "hash": hash_, "salt": "$".join(split_hash[:3])}
                    uncracked_users.append(user_dict)
    if not uncracked_users:
        print("[-] No valid users/hashes found in file. Is it in the correct format?")
        exit(-1)

    try:
        with open(args.dictionary, "r", errors="ignore") as dict_file:
            # load up the next PASS_CHUNK_SIZE passwords to try
            passwords_tried = 0
            generator = lazy_load(dict_file)
            for word in generator:
                if not uncracked_users:  # we're done
                    exit(0)
                for user in uncracked_users:
                    passwords_tried += 1
                    result = test_pass(word, user)
                    if result:
                        uncracked_users.remove(user)

                delta = datetime.now() - start_time
                elapsed_seconds = delta.total_seconds()
                if passwords_tried % 100 == 0:
                    print(f"\r[*] Passwords tried: {passwords_tried} in {round(elapsed_seconds)} "
                           f"seconds (avg {round(passwords_tried/elapsed_seconds)}/sec), uncracked "
                           f"users left: {len(uncracked_users)}", end="")
            if uncracked_users:
                final_uncracked_users = ", ".join(item["name"] for item in uncracked_users)
            print(f"\n[-] Could not find a password for user(s) {final_uncracked_users}")
    except FileNotFoundError as err:
        print(f"[-] {err}")


if __name__ == "__main__":
    main()
