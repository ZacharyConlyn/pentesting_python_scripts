#!/usr/bin/env python3

import zipfile
import itertools
from concurrent.futures import ThreadPoolExecutor
from datetime import datetime
import argparse
from helper_functions import lazy_load

# constants you can change
MAX_WORKERS = 1
PASS_CHUNK_SIZE = 2500 # group of passwords sent out to threads at a time

def extract_file(pw: str, zip_file: zipfile.ZipFile, password_data: list) -> None:
    if password_data[0]:
        return
    pw = pw.strip("\n")
    try:
        password_data[1] += 1
        zip_file.extractall(pwd=pw.encode())
    except (RuntimeError, zipfile.BadZipFile):  # bad password
        return
    print(f"\n[+] Found password: {pw}")
    password_data[0] = pw


def main():
    password_data = [None,0] # [0] is the password, [1] is the number of passwords tried
    parser = argparse.ArgumentParser()
    optional = parser._action_groups.pop()
    required = parser.add_argument_group("required arguments")
    optional = parser.add_argument_group("optional arguments")
    required.add_argument("-z", "--zipfile", type=str, help="file to unzip", required=True)
    required.add_argument("-d", "--dictionary", type=str, help="dictionary file to use", required=True)
    args = parser.parse_args()
    try:
        zip_file = zipfile.ZipFile(args.zipfile)
    except FileNotFoundError as err:
        print(f"\n[-] {err}")
        exit(-1)
    start_time = datetime.now()
    try:
        with open(args.dictionary, "r", errors="ignore") as dict_file:
            generator = lazy_load(dict_file)
            next_list = [word for word in itertools.islice(generator, PASS_CHUNK_SIZE)]
            while next_list:
                with ThreadPoolExecutor(max_workers=MAX_WORKERS) as tp_exec:
                    for pw in next_list:
                        if password_data[0]:
                            password = password_data[0]
                            passwords_tried = password_data[1]
                            elapsed_time = (datetime.now() - start_time)
                            hours, minutes, seconds = str(elapsed_time).split(":")
                            hours = str(int(hours))
                            minutes = str(int(minutes))
                            seconds = str(round(float(seconds)))
                            print(f"[+] Password '{password}' found in {passwords_tried} tries, "
                                  f"{hours} hours, {minutes} minutes, and {seconds} seconds.")
                            exit(0)
                        tp_exec.submit(extract_file, pw, zip_file, password_data)
                    tp_exec.shutdown(wait=True)
                if password_data[0] is None:
                    delta = datetime.now() - start_time
                    elapsed_seconds = delta.total_seconds()
                    passwords_tried = password_data[1]
                    print(f"\r[*] {passwords_tried} passwords tried in {round(elapsed_seconds)} "
                            f"seconds (avg {round(passwords_tried/elapsed_seconds)}/sec)", end="")
                    next_list = [pw for pw in itertools.islice(generator, PASS_CHUNK_SIZE)]

        print(f"\n[-] Correct password not found.")
    except FileNotFoundError as err:
        print(f"\n[-] {err}")


if __name__ == "__main__":
    main()
